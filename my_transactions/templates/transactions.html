{% extends 'base.html'%}
{%load static %}
{% block content %}
<div id="pk_validation">
  <div class="container">
    <div class="row">
      <div class="col-12 text-center mx-auto">
        <form method="POST" action="{% url 'validate_key' %}">
          {% csrf_token %}
          <label for="private_key">Enter your private key:</label>
          <input type="text" name="private_key" id="private_key" required>
          <button type="submit" class="btn btn-secondary button shadow mt-3 mb-3">Validate</button>
          <div id="response"></div>
        </form>
      </div>
    </div>
  </div>
</div>
<div id="transactions-main">
  <div class="container">
    <div class="row">
      <div class="col-12 text-center mx-auto">
        <h3>Balance : {{profile.balance}}</h3>
        <h3> Sending address: {{profile.sending_address}}</h3>
        <h3>Receiving address: {{profile.receiving_address}}</h3>
        <div class="vstack gap-2 col-md-5 mx-auto">
          <div>
            <a href="{% url 'send_payment'%}" class="btn btn-secondary button shadow mt-3 mb-3">Send
              Payment</a>
          </div>
          <div>
            <label for="top-up-amount">Top Up</label>
            <input type="number" id="top-up-amount" min="1" placeholder="Amount in USD" required class="user-container rounded-3 shadow">
            <br>
            <a href="{% url 'create_checkout_session' %}" id="top-up-link"
              class="btn btn-secondary button shadow mt-3 mb-3">Top
              Up</a>
          </div>
          <div>
            <a href="{% url 'transactions_history' %}" class="btn btn-secondary button shadow mt-3 mb-3">History</a>
          </div>
          <div>
            <a href=" {% url 'withdraw_fund' %}" class="btn btn-secondary button shadow mt-3 mb-3">Withdraw</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.querySelector("#top-up-link").addEventListener("click", async (e) => {
    e.preventDefault();

    // Get the entered amount from the input field
    const amountInput = document.querySelector("#top-up-amount").value;

    // Convert amount to cents (e.g., $20.00 -> 2000 cents for Stripe)
    const amountInCents = parseInt(amountInput * 100);

    // Validate the amount
    if (isNaN(amountInCents) || amountInCents <= 0) {
      alert("Please enter a valid amount.");
      return;
    }

    // Send the amount to the backend
    const response = await fetch("{% url 'create_checkout_session' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({ amount: amountInCents })  // Send the amount in cents
    });

    const data = await response.json();
    if (data.url) {
      window.location.href = data.url;  // Redirect to the checkout session URL
    } else {
      alert("An error occurred: " + data.error);
    }
  });

  // Validation handler for the form submission
  document.querySelector("form").onsubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);

    const response = await fetch("{% url 'validate_key' %}", {
      method: "POST",
      body: formData,
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    });

    const result = await response.json();
    if (result.status === 'success') {
      document.getElementById('transactions-main').style.display = 'unset';
      document.getElementById("pk_validation").style.display = 'none';
      document.getElementById("response").style.display = 'none';
    } else {
      document.getElementById("response").innerText = result.message;
    }
  };
</script>
{% endblock %}